# ノードのバックアップと復元

ノードが起動したら、災害復旧を準備する時です。ハードウェアやソフトウェアの問題、あるいは自然災害の発生で機器に壊滅的な障害が発じた場合に備え、バックアップを準備することが最善策です。

実行時、データベースを備えた完全なノードのインストールが数ギガバイトのサイズ規模で大きくなることがあります。このような大量のデータをバックアップし復元する必要がある場合は、高額の費用がかかり、複雑で時間がかかることがあります。幸いにも、良い方法があります。

すべてをバックアップし復元する代わりに、必須のファイルだけをバックアップする必要があります。つまり、ノードに固有で再構築できないファイルのバックアップです。Avalanchegoノードでは、固有のファイルは、ネットワーク上のノードを識別するものです。言い換えると、NodeIDを定義するファイルです。新しい機器にノードをインストールすることで、インストール自体を簡単に再構築できます。そしてブロックチェーンデータの残りのギガバイトは全て、その他のネットワークのピアからデータをコピーするブートストラッピングのプロセスにより簡単に再構築できます。

ノードがネットワーク上のバリデーターで、複数のデリゲーションがある場合でも、その他のものをバックアップする心配は無用です。理由は、バリデーションやデリゲーション取引はブロックチェーンにも保存され、残りのブロックチェーンデータと一緒にブートストラップ中に復元されるためです。

## NodeID

NodeIDとは、ネットワーク上の他のすべてのピアとノードを区別する固有の識別子です。`NodeID-5mb46qkSBj81k9g9e4VFjGGSbaaSLFRzD`のようにフォーマットされた文字列です。[こちら](../../references/cryptographic-primitives.md#tls-addresses)でNodeIDの構築方法に関する技術的な背景を確認することができます。本質的に、NodeIDは2つのファイルで定義されます。

* `staker.crt`
* `staker.key`

デフォルトのインストールでは、作業ディレクトリ(具体的には`~/.avalanchego/staking/`で見つけることができます。別の機器でノードを再作成するために必要なのは、こうした同じ2つのファイルで新しいインストールを実行することです。

{% hint style="warning" %}ノードのキーストアでユーザーが定義された場合、それらの情報をバックアップし、復元する必要があります。[Keystore API](../../avalanchego-apis/keystore-api.md)には、ユーザーの鍵をエクスポート、インポートするのに使用できるメソッドがあります。Keystore APIは、開発者のみが使用し、本番環境でのノード使用を意図したものではないことにご注意ください。keystore APIが何か知らず、使用したことがない場合は、心配する必要はありません。{% endhint %}

## バックアップ

ノードをバックアップするには、(1)`staker.crt`と(2)の`staker.key`ファイルを安全でプライベートな場所に保管する必要があります。できれば、別のコンピューターやクラウド、USBスティックなどのプライベートなストレージに保管することが好ましいです。別の安全な場所にそれらを保有することにより、安全性を高めることができます。

{% hint style="warning" %}誰かがあなたのstakerファイルを手に入れても、ノードではなくウォレットの秘密鍵によって制御されているため、あなたの資金を手に入れることはできません。ただし、別の場所でノードを再作成することは可能なため、状況によってはステーキング報酬を失うことがあります。よって、stakerファイルは必ず安全な場所に保管してください。{% endhint %}

ノードを実行している機器からstakerファイルを取得しましょう。

### ローカルノードから

デスクトップコンピュータでノードをローカルで実行している場合は、ファイルがある場所に移動し、安全な場所にコピーするだけです。

デフォルトのLinuxインストールでは、それらへのパスは`/home/USERNAME/.avalanchego/staking/`となります。ここでは`USERNAME`がノードを実行している実際のユーザー名に置き換えられる必要があります。そこからバックアップ場所にファイルを選択し、コピーします。このためにノードを停止する必要はありません。

### `scp`を使ってリモートノードから

`scp`は「安全なコピー」コマンドラインプログラムで、LinuxやMacOSコンピュータ上で利用可能なビルトインです。[PuTTY](https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html)パッケージの一部として`pscp`、Windows版もあります。`pscp`を使う場合は、`scp`の各使用法を`pscp -scp`に置き換えられます。

ノードからファイルをコピーするには、リモートでにログインできる必要があります。アカウントパスワードを使用できますが、安全で推奨される方法は、SSH鍵を使用することです。SSH鍵を取得し、設定するための手順は、クラウドプロバイダーやの設定に強く依存しています。これらのプロバイダーに関しては、[Amazon Web Services](setting-up-an-avalanche-node-with-amazon-web-services-aws.md)と[Microsoft Azure](set-up-an-avalanche-node-with-microsoft-azure.md)のセットアップガイドを参照してください。他のプロバイダーにも同様の手順があります。

マシンにリモートログイン手段がある場合は、次のコマンドでファイルをコピーできます。

```text
scp -r ubuntu@PUBLICIP:/home/ubuntu/.avalanchego/staking ~/avalanche_backup
```

これは、マシン上のユーザー名が`ubuntu`で、違う場合は両方の場所で正しいユーザー名に置き換えられます。`PUBLICIP`がの実際の公開IPに置き換えられます。`scp`(1)が自動的にダウンロードされたSSH鍵を使用しない場合は、手動でそれを指すことができます。

```text
scp -i /path/to/the/key.pem -r ubuntu@PUBLICIP:/home/ubuntu/.avalanchego/staking ~/avalanche_backup
```

実行後、このコマンドはホームディレクトリで`avalanche_backup`のディレクトリを作成し、その中にstakerファイルを配置します。これらは安全な場所に保管する必要があります。

## 復元

バックアップからノードを復元するには、逆をする必要があります。 つまり、`staker.key`と`staker.crt`をバックアップからノードの作業ディレクトリへ復元します。

まず、ノードの通常の[インストール](set-up-node-with-installer.md)を行う必要があります。このことにより新しいNodeIDが作成されますが、これは置き換える必要があります。ノードが正しくインストールされた場合は、ノードが実行されているマシンにログインし、それを停止します。

```text
sudo systemctl stop avalanchego
```

ノードを復元する準備ができました。

### ローカルノードへ

ローカルでノードを実行している場合は、バックアップ場所から`staker.key`と`staker.crt`ファイルを作業ディレクトリにコピーします。デフォルトのLinuxインストール上にあるものは`/home/USERNAME/.avalanchego/staking/`です。`USERNAME`を、ノードを実行するための実際のユーザー名に置き換えます。

### `scp`を使ってリモートノードへ

繰り返しますが、プロセスは逆の操作となります。`scp`を使用するには、バックアップ場所から`staker.key`と`staker.crt`ファイルをリモート作業ディレクトリにコピーする必要があります。バックアップファイルが、上記のバックアップ手順で配置されたディレクトリにあるとします。

```text
scp ~/avalanche_backup/staker.* ubuntu@PUBLICIP:/home/ubuntu/.avalanchego/staking
```

または、SSH鍵へのパスを指定する必要がある場合です。

```text
scp -i /path/to/the/key.pem ~/avalanche_backup/staker.* ubuntu@PUBLICIP:/home/ubuntu/.avalanchego/staking
```

改めて、違う場合は`ubuntu`を正しいユーザー名に置き換えます。そして`PUBLICIP`を、ノードを実行している機器の実際の公開IPと置き換え、使用されている場合はSSH鍵へのパスにも置き換えます。

### ノードを再起動し、検証する

ファイルが置き換えられたら、機器にログインし、以下を使用してノードを開始します。

```text
sudo systemctl start avalanchego
```

以前のコマンドを実行した同じコンソールで[getNodeID](https://docs.avax.network/build/avalanchego-apis/info-api#info-getnodeid) APIの呼び出しを発行することで、ノードが正しいNodeIDで復元されるのを確認することができます。

```text
curl -X POST --data '{
    "jsonrpc":"2.0",
    "id"     :1,
    "method" :"info.getNodeID"
}' -H 'content-type:application/json;' 127.0.0.1:9650/ext/info
```

元のNodeIDを見る必要があります。復元プロセスが完了しました。

## まとめ

ノードを保護する重要な部分が、ノードの完全で欠点のない復元を可能にするバックアップです。このチュートリアルに従うと、ノードを最初から復元する必要がある状況に陥った場合でも、簡単かつ迅速に復元できることを知っているので安心できます。

このチュートリアルで問題が発生した場合、共有したいコメントを残してください。また、チャットをしたい場合は、[Discord](https://chat.avalabs.org/)サーバー上でご連絡ください。

