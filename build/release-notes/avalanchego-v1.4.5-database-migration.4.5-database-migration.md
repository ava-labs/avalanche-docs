# AvalancheGo v1.4.5：データベースマイグレーション

AvalancheGo < v1.4.5からAvalancheGo >= v1.4.5にアップグレードする場合、この記事は適用されます。この記事は、v1.4.5のために書かれ、以下のバージョンを参照していますが、例えばAvalancheGo v1.4.4からAvalancheGo v1.4.6、v1.4.7などにアップグレードする場合でも適用されます。このドキュメントを読む際、v1.4.5を更新するバージョンに置き換えてください。（データベースサブディレクトリ v1.4.5を参照してはいけません。

## 概要

* [AvalancheGo v1.4.5](https://github.com/ava-labs/avalanchego/releases/tag/v1.4.5)により、重要なデータベース最適化が可能になります。
* AvalancheGoで使用されるディスクスペースの量を一時的に倍増し、メモリとCPUの使用量を一時的に増やします。
* この文書全体を読んで、ノードが正常に移行し、移行中に健康的なままであることを確認してください。あなたの質問に答えが出ない場合、[Discord](https://chat.avalabs.org/)サービスにアクセスし、ペン付きされたメッセージを読んで、あなたの質問を探してください。まだ助けが必要な場合、#トラブルシューティングチャンネルに投稿してください。

## 背景

AvalancheGoの[v1.4.5](https://github.com/ava-labs/avalanchego/releases/tag/v1.4.5)のリリースをお知らせいたします。このリリースにより、AvalancheGoに大きな最適化と安定性の向上をもたらします。

テストでは、以下のグラフに示すように、メインネットバリデータ上で読み取りI/Oが低下するよう、テストしています。

![](../../.gitbook/assets/0%20%281%29%20%282%29%20%283%29.png)

改善は、P-Chainで提供されるステートマネジメントを大幅にリファクタリングし、他の他のデータベース最適化により行われています。

>=v1.4.5にアップグレードされたノードは、より少ないCPUで移行が完了すると、より少ないディスク読み取りを実行するものと期待しています。こうした変更により、P-Chain決定遅延が大幅に改善されます。

このアップグレードにより、ブートストラップにかかる時間を大幅に短縮します。

## アップグレードプロセス

コンピュータ上に既存のデータベースがある場合、AvalancheGo v1.4.5を実行すると、実際に2つのノードが開始されます。「古い」データベースバージョン（v1.0.0）を使用するv1.4.4を実行します。もう一方は、v1.4.5を実行します。（v1.4.5は、AvalancheGo <=1.4.5と同じようにする「新しい」データベースフォーマットを使用するものです。

v1.4.4ノードは通常のように実行され、以前のようにログが表示されます。ノードは、以前と同じノードIDを使用してネットワークに接続し、バリデータである場合、以前と同様にコンセンサスに参加します。つまり、v1.4.4を実行する際と同じように見えるはずです。

v1.4.5ノードは、バックグラウンドで実行され、同じコンピュータ上で実行されるv1.4.4ノードからブートストラップされます。これは、インターネット上でデータが送信される必要が通常のブートストラップ手順より少ない帯域幅を使用します。ブートストラッププロセス中にv1.4.5ノードは、「新しい」データベースが表示されます。

v1.4.5ノードがブートストラップが完了すると、v1.4.4ノードが停止し、v1.4.5ノードが再び開始されます。v1.4.5ノードが再起動すると、「新しい」データベースを使用して通常通り実行され、マイグレーションが完了します。ノードは、以前と同じノードIDが取得されます。

フラグを提供すべきではありません`--plugin-dir`。AvalancheGoをインストールする際にインストールするスクリプトを使用する場合、AvalancheGoサービスファイルからこのフラグを削除する必要があります。この[ノート](avalanchego-v1.4.5-database-migration.md#note-for-the-nodes-installed-with-installer-script)を見る。

## リソース使用量

移行中に、両方のノードが実行されている場合、AvalancheGoは通常よりも多くのシステムリソースを消費します。

移行が完了すると、コンピュータ上に2つのブートストラップデータが存在します。コンピュータ上の空きディスク容量が、完全にブートストラップされたデータベース（~38GB）を超えることを確認してください。AvalancheGoに、少なくとも200GB以上のディスクスペースをコンピュータ上に置くことを推奨します。AvalancheGoは、現在、その分の金額しか使用していませんが、分割的なソリューションを実装する前に、ディスク使用量が増加すると予想しています。

両方のノードが実行されている間に、メモリとCPUの使用量が高まります。AvalancheGoで利用可能なCPU>=2GHzと>=6GBのRAMを持つコンピューターが、問題は発生しません。とはいえ、最初の数日間は、ノードを特に注意深く監視し、健康であることを確実にしてください。

あなたのコンピューターが適切なディスクスペースを持っているか、そして推奨されるスペックより低い場合にどう対応するかについては、[FAQ](https://app.gitbook.com/@avalanche/s/avalanche/build/release-notes/avalanchego-v1.4.5-database-migration#faq)を参照してください。

## ステップバイステップアップグレード手順

* **これらの命令に従うことにより、ノードにダウンタイムが存在することはありません。**
* **データベースとキーストアデータとバリデータが稼働する時間が自動的に移行されます。**

### 要件を確認する

あなたのコンピュータが以下の要件を満たしていることを確認する：

* CPU >= 2GHz
* RAM
* ハードドライブ：現在占有されているディスクスペースの1.3倍以上で_`$HOME/.avalanchego/db/mainnet/v1.0.0`_、38GB程度である必要があります。つまり、50GB程度の空き領域を持つべきであることを意味します。そうでなければ、プログラムはデータベースアップグレードが行くことができなくなります。AvalancheGoに、少なくとも200GB以上のディスクスペースをコンピュータ上に置くことを推奨します。あなたが持っている空きを確認するには、[現在利用可能であるディスク容量](https://docs.avax.network/build/release-notes/avalanchego-v1.4.5-database-migration#how-much-disk-space-is-available-right-now)を参照してください。
* 救済のために、以下のことを参照してください。
   * [私のコンピューターが十分なディスクスペースを持たない場合、どうすればいいですか？](https://docs.avax.network/build/release-notes/avalanchego-v1.4.5-database-migration#what-should-i-do-if-my-computer-doesnt-have-enough-disk-space)
   * [私のコンピューターが2ノードで一度に実行できない場合、どうすればよいですか？](https://docs.avax.network/build/release-notes/avalanchego-v1.4.5-database-migration#what-if-my-computer-cant-run-2-nodes-at-once)

### バックアップデータ

これに従い、ノードデータをバックアップ[します。](https://docs.avax.network/build/tutorials/nodes-and-staking/node-backup-and-restore)

ステーキングキー/証明書は、データベースに含まれず、データベース移行**によってまったく影響を受ける**ことはありません。それでも、ステーキングキー/証明書を[バックアップ](https://docs.avax.network/build/tutorials/nodes-and-staking/node-backup-and-restore)するのは良い慣行です。

### 新しいバージョンをダウンロードする

****新しいバージョンは、あなたの慣行により、以下のアプローチでダウンロードすることができます。

* [インストーラスクリプト](https://docs.avax.network/build/tutorials/nodes-and-staking/set-up-node-with-installer#node-upgrade)で、実行_`./avalanchego-installer.sh`_
* バイナリダウンロードで、[ここを](https://docs.avax.network/build/tutorials/nodes-and-staking/run-avalanche-node#binary)参照してください
* ソースコードからビルド[する](https://docs.avax.network/build/tutorials/nodes-and-staking/run-avalanche-node#source-code)

### 新しいバージョンを実行する

新しいバージョンを始める

* AvalancheGoを実行する場合、我々が強く推奨するサービスとしてAvalancheGoを実行する場合、_`--plugin-dir`_フラグがファイルに存在しないことを確認してください_`avalanchego.service`_。存在しない場合、次の段落をスキップすることができます。表示が完了した場合は、以下の手順に従って削除してください。

   コンソールで、コマンドを入力します：_`sudo nano /etc/systemd/system/avalanchego.service`_  _`ExecStart=`_エディタで、以下で始まるラインを見つけて、以下のパート削除します。_`--plugin-dir=/home/ubuntu/avalanche-node/plugins`_その後、ctrl-xとyを押すことで変更を保存します。

   変更を適用するには、コマンドを実行します：  _`sudo systemctl daemon-reload`_  最後に、次のようにノードでノードを再起動します。  _`sudo systemctl restart avalanchego`_

* ソースコードからバイナリダウンロードあるい[は](https://docs.avax.network/build/tutorials/nodes-and-staking/run-avalanche-node#start-a-node-and-connect-to-avalanche)ビルドでご利用いただけます。

### モニタープログレス

モニターし、マイグレーションが正常に完了することを確認してください。

以下の操作で進捗を確認することができます：

* コマンドを使用して、ディスクスペース確認

   _`du -h $HOME/.avalanchego/db/mainnet`_

   v1.0.0とv1.4.5の下で両方のデータベースサイズを示す結果が生じるはずです。

* 新しいデータベースを作成するノードログは、下記のように見ることができます。_`$HOME/.avalanchego/logs/fetch-only`_
* これらのメッセージは、データベース移行が完了したことを示します：
   * _`"starting latest node version in normal execution mode"`_**印刷が完了し、新しい**データベースがブートストラップされ、ノードが再スタートしました。
   * _`"finished migrating keystore from database version v1.0.0 to v1.4.5"`_****印刷が完了します。
   * _`"finished migrating platform vm from database version v1.0.0 to v1.4.5"`_印刷が完了し、バリデータ稼働**時間が終了**します。

お使いのコンピュータにより、アップグレードプロセスに大幅な時間がかかる可能性があります。一部のバリデータは、より少ないパワフルなコンピュータで30時間を超える場合を報告しています。主に、コンピュータ上のストレージの種類によって異なります。SSDベースである場合、12時間以内で完了する必要があります。HDDベースのシステムでは、数日かかることがあります（移行はほぼランダムな読み取り/書き込みで、HDDはこれらのタイプのワークロードで非常に遅くなります）。しかし、ダウンタイムなしでマイグレーション中にノードが動作し続けるようになります。

`info.getNodeVersion`APIを発行することでノードのバージョンを確認することができます。（[Postman](https://docs.avax.network/build/tools/postman-avalanche-collection)上のチュートリアルを参照）。ここで、移行が完了した後、バージョン番号が1.4.7でなければなりません。

```javascript
{
    "jsonrpc": "2.0",
    "result": {
        "version": "avalanche/1.4.7"
    },
    "id": 1
}
```

ノード更新に関するより詳細な情報は[ここ](https://docs.avax.network/build/tutorials/nodes-and-staking/upgrade-your-avalanchego-node)から入手できます。

## FAQ

### [エクスプローラ]が、私のノードはv1.4.4にまだ存在していると言われる理由がありますか？

移行中に、上記のようにv1.4.4ノードがコンピュータ上で実行されます。マイグレーションが完了するまで、ネットワーク上の他のノードはv1.4.4を実行すると見ることができます。

### データベース移行義務ですか？

はい。AvalancheGo < v1.4.5を実行するノードは機能しなくなりました。

### v1.4.4以外のバージョンからAvalancheGo 1.4.5にアップグレードすることは可能ですか？

はい、1.4.5未満のバージョンから動作するはずです。

### 私のコンピューターが2ノードで一度に実行できない場合、どうすればよいですか？

あなたのコンピュータ（コンピュータ1）が6GB未満のRAMで2つのノードを一度に実行するのに十分なメモリがないので、マイグレーションを実行できない可能性があります。思い出として、ノードには6GB以上のRAMがあることをお勧めします。

マイグレーションを実行できず、ノードがオフラインである時間を最小限にしたい場合、以下のことが可能です。

* 別のコンピュータ（コンピュータ2）で、AvalancheGo v1.4.5を実行し、ブートストラップを待ち、AvalancheGoを停止します。
* コンピュータ1でAvalancheGoを停止します。コンピュータ2_`$HOME/.avalanchego/db/`_から（ブートストラップされたばかりのデータベースバージョン v1.4.5）の場所に移動します。その後、AvalancheGo v1.4.5にアップグレードし、実行します。

****これは、推奨されたアプローチではなく、あなたのノードが6GB未満のRAMまたはディスク容量が存在する場合に限り、そのようにしてください。繰り返します。このアプローチは、キーストアやバリデータ更新時間データは移行しないことに注意してください。

### ディスク容量はどのくらい必要ですか？

AvalancheGoに、少なくとも200GB以上のディスクスペースをコンピュータ上に置くことを推奨します。AvalancheGoは、現在、その額の分数（〜38GB）しか使用されていませんが、分割のソリューションを実装する前に、ディスク使用量が増加すると予想しています。

### 現在利用可能になるディスク容量はどのくらいですか？

Mac OSあるいはLinux上のデータベースディレクトリで利用可能なディスク容量を確認するには、以下のようにしてください。

_`df -h $HOME/.avalanchego/db`_

たとえば、この出力により、609 GBのディスクスペースが利用可能になると言われています。

_`Filesystem Size Used Avail Use% Mounted on`_

_`/dev/nvme0n1p2 916G 261G 609G 30% /`_

### 新しいデータベースがブートストラップするまでにどのくらいかかりますか？

約30時間かかることができます。しかし、あなたのコンピュータによっては、多少なかれ時間がかかる場合があります。

### データベース移行が完了したことをどのように私は知るのですか？

_`"starting to run node in normal execution mode"`_印刷が完了し、新しいデータベースがブートストラップされ、ノードが再スタートしました。

_`"finished migrating keystore from database version v1.0.0 to v1.4.5"`_印刷が完了します。

_`"finished migrating platformvm from database version v1.0.0 to v1.4.5"`_印刷が完了し、バリデータ稼働時間が終了します。

### 古いデータベースを削除することはできますか？

新しいデータベースバージョンが起動すると、v1.4.5ノードは再起動し、データベース移行を完了します。このことが発生した後、デフォルトで以下のように設定されます。

_`$HOME/.avalanchego/db/mainnet/v1.0.0`_

古いデータベース（v1.0.0）を削除する必要はありません。

### この移行は、古いデータベース内の何か変更はありませんか？

いいえ。\*\*古いデータベース（v1.0.0）は変更はありません。

**しかし、ノードが実行されている中にデータベースを変更することは絶対にありません。**

明確にすると、新しいデータベースブートストラップ後に古いデータベースを削除する場合：

* 新しいデータベースブートストラップとノードが再起動するまでv1.4.5を実行します
* ノードを停止
* データベースのv1.0.0サブディレクトリを削除します（そのサブディレクトリのみ！）
* ノードを開始

**古いデータベースを削除する前に、鍵ストアデータが正常に移行されていることを確認する必要があります。**

### バリデータ更新時間とキーストアデータは移行されますか？

はい。しかし、注意としてAvalancheGo v1.4.5を実行する前に、ステーキングキー/証明書と鍵ストアデータを[バックアップ](https://docs.avax.network/build/tutorials/nodes-and-staking/node-backup-and-restore)する必要があります。

### v1.4.5ノードについて、バックグラウンドでログが表示されるようになります。

_`$HOME/.avalanchego/logs/fetch-only`_デフォルトで、これらのログは .

### 私のコンピューターが十分なディスクスペースを持たない場合、どうすればいいですか？

ノードがクラウド上で動作しない場合、ノードデータを[バックアップ](https://docs.avax.network/build/tutorials/nodes-and-staking/node-backup-and-restore)し、より多くのディスクスペースを持つマシンに移動し、AvalancheGoを実行してください。

あなたのノードがクラウド上で実行される場合、あなたのクラウドプロバイダーから利用可能なディスクスペースの数を増やす命令を取得します。ドキュメントを見る。

### 何かがエラーが発生した場合、以前のバージョンに戻る方法は？

[こちら](https://docs.avax.network/build/tutorials/nodes-and-staking/set-up-node-with-installer#using-a-previous-version)を参照してください。この移行は、既存のデータベース内のデータは変更することはありません。新しいデータベースが作成されます。AvalancheGo v1.4.5からv1.4.4に至るまでの問題が発生した場合、既存のデータベースが変更されないため、ダウングレードが発生する場合、問題が発生するはずです。（つまり、既存のデータベースが削除されていないと仮定します）。

### 更新により、バリデータが稼働する時間が減少しますか？

このドキュメントで記載されている指示に従えば、いいえ。 バックグラウンドで新しいデータベースブートストラップが作成される間、ノードはコンセンサスで参加し続けることになります。空のデータベースからバリデータを再起動する場合、ブートストラップ中にクエリに反応しないため、オフラインとしてマークされます。したがって、あなたが避けることができれば、空のデータベースから再ブートストラップをするべきではありません。

### ブートストラップ

おそらくそうではありません。あなたのノードがバリデータである場合、そのため、稼働時間が低下するようになります。（上記の回答を参照してください）。あなたのノードがバリデータでないが、すでにブートストラップが行われている場合、空のデータベースから再ブートストラップするよりも、データベースの移行が速くなります。どちらの場合も、既存のv1.0.0データベースを削除するのではなく、上記で説明したように、マイグレーションを実行する方が良いでしょう。

### **マイグレーション/ブートストラップ中に私のノードがシャットオフされます。私が何をするのですか？**

ノードを再起動するだけです。移行は、オフの場所に持ち出されます。AvalancheGoをサービスとして実行するように設定することをお勧めします。

### 何かが間違っていると思います。私が何をするのですか？

**まず、このドキュメントを完全に読んでいるようにしてください**。どこかであなたの質問に答えるかもしれません。答えが表示されない場合、[Discord](https://chat.avalabs.org/)サーバーにアクセスし、あなたの質問を検索します。すでに質問が完了していない場合、#トラブルシューティングチャンネルに投稿してください。

### Orteliusを使用します。

Orteliusを使用する場合、以下のステップに従ってアップグレードしてください。

* 古いOrteliusインスタンスを実行しておく。
* 最新バージョンを実行する新しいOrteliusインスタンスを別のコンピュータ上にインストールします。
* 新しいOrteliusインスタンスがブートストラップが完了した後、新しいインスタンスに切り替えます。
* 古いOrteliusインスタンスをシャットダウンします。

Orteliusをデプロイするための手順は[、https://github.com/ava-labs/ortelius/blob/master/docs/docs/deployment.md](https://github.com/ava-labs/ortelius/blob/master/docs/deployment.md) からご覧いただけます。

Orteliusリリースで変更される1つの変更は、Orteliusがノード内のインデックスサーを使用するようになります。これにより安定性が向上し、Orteliusに再起動が可能になったとしても、オルテリウスにミッスンされたトランザクションが存在しないようにします。

### インストーラースクリプトでインストールされたノードのための注意

インストーラスクリプトでノードがインストールされた場合[、](https://docs.avax.network/build/tutorials/nodes-and-staking/set-up-node-with-installer)1.4.5にアップグレードした後、サービス定義ファイルを修正する必要があります。コンソールで、コマンドを入力します：_`sudo nano /etc/systemd/system/avalanchego.service`_  _`ExecStart=`_エディタで、以下で始まるラインを見つけて、以下のパート削除します。_`--plugin-dir=/home/ubuntu/avalanche-node/plugins`_その後、ctrl-xとyを押すことで変更を保存します。

変更を適用するには、コマンドを実行します：  _`sudo systemctl daemon-reload`_  最後に、次のようにノードでノードを再起動します。  _`sudo systemctl restart avalanchego`_

