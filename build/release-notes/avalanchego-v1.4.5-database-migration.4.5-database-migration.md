# AvalancheGo v1.4.5：データベースの移行

この記事は、お使いのノードをAvalancheGo < v1.4.5からAvalancheGo >= v1.4.5にアップグレードする際に適用されます。この記事はv1.4.5について書かれており、以下でそのバージョンを参照していますが、例えば、AvalancheGo v1.4.4からAvalancheGo v1.4.6、v1.4.7などにアップグレードする場合にも適用されます。この文書を読む際は、v1.4.5をアップデートするバージョンに置き換えてください（ただし、データベースのサブディレクトリ v1.4.5については変更されません）。

## まとめ

* [AvalancheGo v1.4.5](https://github.com/ava-labs/avalanchego/releases/tag/v1.4.5)では、データベースが大幅に最適化されました。
* AvalancheGoが使用するディスク容量が一時的に2倍になり、メモリとCPUの使用量が一時的に増加します。
* ノードが正常に移行し、移行中も健全性を保っていることを確認するために、本文書全体をお読みください。本文書が質問の回答になっていない場合は、[Discord](https://chat.avalabs.org/)サーブにアクセスして、ピン留めされたメッセージを読み、質問を検索してください。それでも問題が解決しない場合は、#troubleshootingチャンネルに投稿してください。

## 背景

[AvalancheGoのv1.4.5](https://github.com/ava-labs/avalanchego/releases/tag/v1.4.5)がリリースされました。データベースの最適化や安定性の向上など、AvalancheGoに大幅な改良が加えられています。

テストでは、下のグラフに示すように、Mainnetのバリデーターで読み取りI/Oを約90%削減することができました。

![](../../.gitbook/assets/0%20%281%29%20%282%29%20%283%29.png)

今回の改善は、P-Chainの状態管理の広範なリファクタリングと、その他のデータベースの最適化によるものです。

v1.4.5以上にアップグレードされたノードでは、移行が完了した後、CPUの消費量やディスクの読み取り回数が減少することが予想されます。また、今回の変更により、P-Chainの判定待ち時間が大幅に改善されます。

今回のバージョンアップでは、起動にかかる時間も大幅に短縮されました。

## アップグレードのプロセス

お使いのコンピュータに既存のデータベースがある場合、AvalancheGo v1.4.5を実行すると、実際には2つのノードが起動します。1つはv1.4.4を実行します。これは「古い」データベースバージョン（v1.0.0）を使用します。もう1つはv1.4.5を実行し、「新しい」データベース形式を使用します（v1.4.5は、AvalancheGo <1.4.5のすべてのバージョンで同じままです）。

v1.4.4 のノードは通常通り動作し、これまで通りログを見ることができます。ノードはこれまでと同じノードIDを使ってネットワークに接続し、バリデーターであればこれまでと同じようにコンセンサスに参加します。要するに、v1.4.4 を実行しているときと同じように見えるはずです。

v1.4.5ノードはバックグラウンドで動作し、同じコンピューター上で動作しているv1.4.4ノードからブートストラップします。これは、インターネット上でデータを送信する必要がある通常のブートストラップ手順よりも高速で、使用する帯域幅も少なくて済みます。起動中、v1.4.5 ノードは「新しい」データベースにデータを取り込みます。

v1.4.5 ノードの起動が完了すると、v1.4.4 ノードが停止し、v1.4.5 ノードが再起動します。v1.4.5 ノードが再起動すると、「新しい」データベースを使って正常に動作し、移行が完了します。ノードのノードIDは以前と同じになります。

`--plugin-dir`[](avalanchego-v1.4.5-database-migration.md#note-for-the-nodes-installed-with-installer-script)このフラグを提供してはいけません。インストーラスクリプトを使用してAvalancheGoをインストールした場合は、AvalancheGoサービスファイルからこのフラグを削除する必要があります。このノートを参照してください。

## リソースの使用状況

移行中、両方のノードが稼働していると、アバランチゴーは通常よりも多くのシステムリソースを消費します。

移行が完了すると、コンピュータ上に2つの起動したデータベースができます。お使いのコンピュータの空きディスク容量が、完全に起動したデータベースのサイズ（～38 GB）を超えていることを確認してください。お使いのコンピュータに少なくとも200 GBのディスクスペースをAvalancheGoに割り当てることをお勧めします。現在、AvalancheGo はこの容量のほんの一部しか使用していませんが、プルーニングソリューションを導入する前にディスク使用量が増加することが予想されます。

両方のノードが動作している間は、メモリとCPUの使用率も高くなります。アバランシェゴで使用可能なCPU≧2GHz、RAM≧6GBのコンピュータであれば、問題はないと思われます。とはいえ、最初の数日間は特に注意深くノードを監視して、ノードが健全であることを確認する必要があります。

[](https://app.gitbook.com/@avalanche/s/avalanche/build/release-notes/avalanchego-v1.4.5-database-migration#faq)ディスクの空き容量を確認する方法や、推奨スペック以下の場合の対処法については、FAQをご覧ください。

## ステップバイステップのアップグレード手順

* ****これらの手順に従うことで、あなたのノードがダウンタイムを起こすことはありません。
* ****データベースに加えて、キーストアデータやバリデーターのアップタイムも自動的に移行されます。

### 要件の確認

お使いのコンピューターが以下の条件を満たしていることを確認してください。

* CPU >= 2GHz
* RAM >= 6 GB
* _`$HOME/.avalanchego/db/mainnet/v1.0.0`_[](https://docs.avax.network/build/release-notes/avalanchego-v1.4.5-database-migration#how-much-disk-space-is-available-right-now)ハードディスク：現在(1)(2)(3)で占めているディスク容量の1.3倍以上、約38GBの容量が必要です。つまり、約50GBの空き容量が必要です。そうしないと、プログラムがデータベースのアップグレードを進めることができません。お使いのコンピュータに少なくとも200GBのディスクスペースをAvalancheGoに割り当てることをお勧めします。現在の空き容量を確認するには、「現在使用可能なディスク容量」をご覧ください。
* 改善のためには、以下を参照してください。
   * [](https://docs.avax.network/build/release-notes/avalanchego-v1.4.5-database-migration#what-should-i-do-if-my-computer-doesnt-have-enough-disk-space)パソコンのディスク容量が足りないときはどうすればいいですか？
   * [](https://docs.avax.network/build/release-notes/avalanchego-v1.4.5-database-migration#what-if-my-computer-cant-run-2-nodes-at-once)2つのノードを同時に動作させることができない場合は？

### バックアップデータ

[](https://docs.avax.network/build/tutorials/nodes-and-staking/node-backup-and-restore)このようにして、ノードのデータをバックアップしてください。

****[](https://docs.avax.network/build/tutorials/nodes-and-staking/node-backup-and-restore)お客様のステーキングキー/証明書はデータベースには含まれていませんので、データベースの移行による影響は全くありません。ただし、staking key/certificateのバックアップを取っておくことをお勧めします。

### 新バージョンのダウンロード

****新バージョンのダウンロードは、お客様のご利用状況に応じて、以下のいずれかの方法で行うことができます。

* [](https://docs.avax.network/build/tutorials/nodes-and-staking/set-up-node-with-installer#node-upgrade)_`./avalanchego-installer.sh`_インストーラー・スクリプトでは
* [](https://docs.avax.network/build/tutorials/nodes-and-staking/run-avalanche-node#binary)バイナリのダウンロードはこちら
* [](https://docs.avax.network/build/tutorials/nodes-and-staking/run-avalanche-node#source-code)ソースコードからのビルドについては、こちらをご覧ください。

### 新バージョンの実行

新バージョンを起動するには

* _`--plugin-dir`__`avalanchego.service`_AvalancheGoをサービスとして実行することを強くお勧めしますが、その場合は(4)(5)(6)ファイルに(1)(2)(3)フラグが存在しないことを確認してください。フラグがない場合は、次の段落をスキップすることができます。フラグがある場合は、以下の手順でフラグを削除してください。

   __`sudo nano /etc/systemd/system/avalanchego.service`_  _`ExecStart=`__`--plugin-dir=/home/ubuntu/avalanche-node/plugins`コンソールでコマンドを入力します。(1)(3)(4)(5) エディタで、(6)(7)(8)で始まる行を探し、その行で以下の部分を削除します。(9)(10)(2) その後，ctrl-xとyを押して変更を保存します。

     _`sudo systemctl daemon-reload`_    _`sudo systemctl restart avalanchego`_変更を適用するには、このコマンドを実行します。  最後に、次のコマンドでノードを再起動します。

* [](https://docs.avax.network/build/tutorials/nodes-and-staking/run-avalanche-node#start-a-node-and-connect-to-avalanche)バイナリのダウンロードやソースコードからのビルドについては、こちらをご覧ください。

### 進捗状況の確認

移行が正常に完了したかどうかを監視してください。

進捗状況は以下の方法で確認できます。

* ディスクの使用量を確認するためのコマンド

   _`du -h $HOME/.avalanchego/db/mainnet`_

   と入力すると、v1.0.0とv1.4.5でのデータベースのサイズが表示されます。

* _`$HOME/.avalanchego/logs/fetch-only`_新しいデータベースを作成したノードのログは、以下の場所にあります。
* これらのメッセージは、データベースの移行が完了したことを示しています。
   * _`"starting latest node version in normal execution mode"`_****(1)(2)(3)が表示されたら、新しいデータベースの起動が完了し、ノードが再起動したことになります。
   * _`"finished migrating keystore from database version v1.0.0 to v1.4.5"`_****(1)(2)(3)が表示されたら、キーストアデータの移行が終了したことになります。
   * _`"finished migrating platform vm from database version v1.0.0 to v1.4.5"`_****(1)(2)(3)が印刷されると、バリデーターのアップタイムの移行が終了します。

お使いのコンピュータによっては、アップグレード作業にかなりの時間がかかる場合があります。高性能ではないコンピュータで30時間以上かかったというバリデーターもあります。これは主に、コンピュータに搭載されているストレージの種類によります。SSDベースのストレージであれば、12時間以内に完了するはずです。HDDベースのシステムでは、数日かかることもあります（マイグレーションはほとんどがランダムな読み書きであり、HDDはこの種のワークロードではかなり遅いのです）。ただし、移行中もノードはダウンタイムなしに動作します。

`info.getNodeVersion`[](https://docs.avax.network/build/tools/postman-avalanche-collection)ノードのバージョンを確認するには、(1)のAPIを発行して（Postmanのチュートリアルを参照）、以下のようなレスポンスを得ることができます。移行完了後、どのバージョンにアップデートするかによって、バージョン番号が>>1.4.7になっているはずです。

```javascript
{
    "jsonrpc": "2.0",
    "result": {
        "version": "avalanche/1.4.7"
    },
    "id": 1
}
```

ノードのアップデートについての詳細は[こちら](https://docs.avax.network/build/tutorials/nodes-and-staking/upgrade-your-avalanchego-node)をご覧ください。

## よくある質問

### なぜ [explorer] は私のノードがまだ v1.4.4 であると言うのですか？

移行中は、上述の通り、あなたのコンピュータ上でv1.4.4ノードが動作します。ネットワーク上の他のノードは、移行が完了するまで、あなたのノードがv1.4.4を実行していると認識します。

### データベースの移行は必須ですか？

はい。AvalancheGo < v1.4.5を実行しているノードは動作しなくなりました。

### v1.4.4以外のバージョンからAvalancheGo 1.4.5にアップグレードすることはできますか？

はい、1.4.5未満のすべてのバージョンで動作します。

### 2つのノードを同時に動作させることができない場合は？

お使いのコンピュータ（コンピュータ1）のRAMが6GB未満の場合、2つのノードを同時に実行するのに十分なメモリがないため、マイグレーションを実行できない可能性があります。念のため、ノードには6GB以上のRAMを搭載することをお勧めします。

移行を実行できず、ノードのオフライン時間を最小限に抑えたい場合は、次のようにします。

* 別のコンピュータ（コンピュータ2）で、AvalancheGo v1.4.5を起動し、起動するまで待ってから、AvalancheGoを停止します。
* _`$HOME/.avalanchego/db/`_コンピュータ 1 で、AvalancheGo を停止します。コンピュータ 2（データベースバージョン v1.4.5 を起動したばかり）のデータベースディレクトリを、コンピュータ 1 の同じ場所に移動します。その後、AvalancheGo v1.4.5 にアップグレードして実行します。

****これは推奨される方法ではなく、ノードのRAMが6GB未満の場合や、ディスク容量が不足している場合にのみ行う必要があることに注意してください。繰り返しになりますが、ノードに6GB以上のRAMと200GB以上のディスクスペースがあることを推奨します。この方法では、キーストアやバリデーターのアップタイムデータは移行されませんのでご注意ください。

### どのくらいのディスク容量が必要ですか？

AvalancheGoには、お使いのコンピュータに少なくとも200GBのディスクスペースを確保することをお勧めします。現在、AvalancheGoはその数分の1（～38 GB）しか使用していませんが、プルーニングソリューションを導入する前にディスク使用量が増加することが予想されます。

### 今、どのくらいのディスク容量があるのか？

Mac OSまたはLinuxでデータベースディレクトリの利用可能なディスク容量を確認するには、次のようにします。

_`df -h $HOME/.avalanchego/db`_

この出力では、例えば、609GBのディスクスペースが利用可能であるとしています。

_`Filesystem Size Used Avail Use% Mounted on`_

_`/dev/nvme0n1p2 916G 261G 609G 30% /`_

### 新しいデータベースの起動にはどのくらいの時間がかかりますか？

30時間程度かかります。ただし、お使いのパソコンによっては、それ以上またはそれ以下の時間がかかる場合があります。

### データベースの移行が完了したことを知るにはどうすればいいですか？

_`"starting to run node in normal execution mode"`_(1)(2)(3)が表示されたら、新しいデータベースの起動が完了し、ノードが再起動したことになります。

_`"finished migrating keystore from database version v1.0.0 to v1.4.5"`_(1)(2)(3)が表示されたら、キーストアデータの移行が終了したことになります。

_`"finished migrating platformvm from database version v1.0.0 to v1.4.5"`_(1)(2)(3)が印刷されると、バリデーターのアップタイムの移行が終了します。

### 古いデータベースを削除することはできますか？

新しいバージョンのデータベースが起動されると、v1.4.5ノードが再起動し、データベースの移行が完了します。この後、古いデータベースのディレクトリを削除することができますが、デフォルトでは

_`$HOME/.avalanchego/db/mainnet/v1.0.0`_

旧データベース(v1.0.0)を削除する必要はありません。

### この移行によって、古いデータベースの何かが変わるのでしょうか？

いいえ**。** 古いデータベース(v1.0.0)は変更されません。

**ただし、ノードの実行中にデータベースを変更することは絶対に避けてください。**

はっきり言って、新しいデータベースが起動した後に古いデータベースを削除したいのであれば

* 新しいデータベースが起動してノードが再起動するまで、v1.4.5を実行してください。
* ノードの停止
* データベースのv1.0.0サブディレクトリを削除する（そのサブディレクトリのみ）。
* ノードの起動

****また、古いデータベースを削除する前に、鍵屋データが正常に移行されたことを確認する必要があります。

### バリデーターのアップタイムやキーストアのデータは移行されますか？

[](https://docs.avax.network/build/tutorials/nodes-and-staking/node-backup-and-restore)ただし、予防措置として、AvalancheGo v1.4.5を実行する前に、ステーキングキー/証明書とキーストアデータをバックアップしてください。

### バックグラウンドでv1.4.5のノードのログを見るにはどうすればいいですか？

_`$HOME/.avalanchego/logs/fetch-only`_デフォルトでは、これらのログは(1)(2)(3)になります。

### パソコンのディスク容量が足りないときはどうすればいいですか？

[](https://docs.avax.network/build/tutorials/nodes-and-staking/node-backup-and-restore)ノードがクラウド上で動作していない場合は、ノードのデータをバックアップし、より多くのディスクスペースを持つマシンに移動させ、そのマシン上でアバランチゴーを実行する必要があります。

ノードがクラウド上で動作している場合は、利用可能なディスク容量を増やすための手順をクラウドプロバイダーから入手してください。そのドキュメントを参照してください。

### 何か問題が発生した場合、どのようにして前のバージョンに戻ることができますか？

[こちら](https://docs.avax.network/build/tutorials/nodes-and-staking/set-up-node-with-installer#using-a-previous-version)を参照してください。この移行は、既存のデータベースのデータを変更するものではありません。新しいデータベースはそれと並行して作成されます。問題が発生してAvalancheGo v1.4.5からv1.4.4にダウングレードした場合、既存のデータベースは変更されていないため、ダウングレードに問題はありません。(これは、既存のデータベースを削除していないことを前提としています）。)

### アップデートするとバリデーターの稼働率が下がる？

このドキュメントの指示に従えば、いいえ。新しいデータベースがバックグラウンドで起動している間も、 あなたのノードはコンセンサスに参加し続けている。空のデータベースからバリデーターを再起動すると、起動中は問い合わせに反応しなくなるので オフラインと判定されるだろう。したがって、できる限り空のデータベースからの再起動は行わないようにしましょう。

### 最初から再起動すればいいのでしょうか？

おそらくないでしょう。もしあなたのノードがバリデーターであれば、これはそのノードのアップタイムを減少させる原因となります。(上記の回答を参照)。あなたのノードがバリデーターではなく、すでにブートストラップしている場合は、 空のデータベースから再ブートストラップするよりも、データベースを移行したほうが早くなります。どちらの場合でも、既存のv1.0.0データベースを削除するよりも、 上記で説明したように移行を実行した方が良いでしょう。

### ****マイグレーション/ブートストラップ中にノードが停止してしまいました。どうしたらいいですか？

ノードを再起動してください。移行は中断したところから再開されます。AvalancheGoをサービスとして実行するように設定し、シャットダウン時に自動的に再起動するようにすることを強くお勧めします。

### 何か変だと思う。どうすればいいんですか？

****[](https://chat.avalabs.org/)まず、（1）このドキュメントをしっかりと読んでください（2）。どこかにあなたの質問の答えがあるかもしれません。答えが見つからない場合は、Discordサーバーで質問を検索してみてください。まだ質問されていない場合は、#troubleshootingチャンネルに投稿してください。

### Orteliusを使っていますが、どうやってアップグレードすればいいですか？

Orteliusをお使いの方は、以下の手順でアップグレードしてください。Orteliusをお使いの方は、以下の手順でアップグレードしてください。

* 古いOrteliusのインスタンスを動かすことができます。
* 最新バージョンのOrteliusインスタンスを別のコンピュータにインストールします。
* 新しいOrteliusインスタンスのブートストラップが終了したら、新しいインスタンスに切り替えます。
* 古いOrteliusのインスタンスをシャットダウンします。

[](https://github.com/ava-labs/ortelius/blob/master/docs/deployment.md)Orteliusを導入するための手順は、https://github.com/ava-labs/ortelius/blob/master/docs/deployment.md にあります。

今回のOrteliusのリリースでの変更点は、Orteliusがノードの内蔵インデクサを使用するようになったことです。これにより安定性が向上し、Orteliusを再起動してもトランザクションの欠落がなくなります。

### インストーラスクリプトでインストールしたノードへの注意

[](https://docs.avax.network/build/tutorials/nodes-and-staking/set-up-node-with-installer)`--plugin-dir=/home/ubuntu/avalanche-node/plugins`__`sudo nano /etc/systemd/system/avalanchego.service`_  _`ExecStart=`__インストーラスクリプトでノードをインストールした場合、1.4.5にアップグレードするとサービス定義ファイルを修正する必要があります。コンソールで、コマンドを入力します。(4)(5)(6)(7)
エディタで、「」で始まる行を探し、その行で以下の部分を削除します。(1)(2)(3) ctrl-x と y を押して変更を保存します。

  _`sudo systemctl daemon-reload`_    _`sudo systemctl restart avalanchego`_変更を適用するには、コマンドを実行します。(1)(2)(3)(4)(5)  
最後に、次のコマンドでノードを再起動します。(6)
(7)(8)(9)

