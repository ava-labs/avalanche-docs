# Deploy a Permissioned Subnet on Mainnet

:::warning

Deploying a Subnet to Mainnet has many risks. Doing so safely requires a laser focus on security.
This tutorial does its best to point out common pitfalls, but there may be other risks not discussed here.

This tutorial is an educational resource and provides no guarantees that following it will result in
a secure deployment. Additionally, this tutorial takes some shortcuts that aid the understanding of
the deployment process at the expense of security. These shortcuts are pointed out and are not
recommended for a production deployment.

:::

After managing a successful Subnet deployment on the `Fuji Testnet`, you're ready to deploy your
Subnet on Mainnet. If you haven't done so, first [Deploy a Subnet on
Testnet](./create-a-fuji-subnet).

This tutorial shows how to do the following on `Mainnet`.

- Create a Subnet.
- Deploy a virtual machine based on Subnet-EVM.
- Add a node as a validator to the Subnet.
- Join a node to the newly created Subnet.

:::note

All IDs in this article are for illustration purposes only. They are guaranteed to be different in
your own run-through of this tutorial.

:::

## Prerequisites

- 5+ nodes running and [fully bootstrapped](../nodes/README.md) on `Mainnet`
- [Avalanche-CLI is installed](install-avalanche-cli) on each validator node's box
- A [Ledger](https://www.ledger.com/) device
- You've [created a Subnet configuration](create-evm-subnet-config) and fully tested a [Fuji Testnet
  Subnet deployment](./create-a-fuji-subnet)

:::warning

Although only one validator is strictly required to run a Subnet, running with less than five
validators is extremely dangerous and guarantees network downtime. Plan to support at least five
validators in your production network.

:::

### Getting Your Mainnet NodeIDs

You need to collect the NodeIDs for each of your validators. This tutorial uses these NodeIDs in
several commands.

To get the NodeID of a `Mainnet` node, call the
[info.getNodeID](../apis/avalanchego/apis/info.md#infogetnodeid) endpoint. For example:

```text
curl -X POST --data '{
    "jsonrpc":"2.0",
    "id"     :1,
    "method" :"info.getNodeID"
}' -H 'content-type:application/json;' 127.0.0.1:9650/ext/info
```

The response should look something like:

```json
{
  "jsonrpc": "2.0",
  "result": {
    "nodeID": "NodeID-5mb46qkSBj81k9g9e4VFjGGSbaaSLFRzD"
  },
  "id": 1
}
```

In the sample response, `NodeID-5mb46qkSBj81k9g9e4VFjGGSbaaSLFRzD` is the NodeID. Note that the
`NodeID-` prefix is part of the NodeID.

### Setting up Your Ledger

In the interest of security, all Avalanche-CLI `Mainnet` operations require the use of a connected
Ledger device. You must unlock your Ledger and run the Avalanche App. See [How to Use
Ledger](https://support.avax.network/en/articles/6150237-how-to-use-a-ledger-nano-s-or-nano-x-with-avalanche)
for help getting set up.

Avalanche-CLI supports the Ledger `Nano X`, `Nano S`, and `Nano S Plus`.

Ledger devices support TX signing for any address inside a sequence automatically generated by the device.

By default, Avalanche-CLI uses the first address of the derivation, and that address needs funds to
issue the TXs to create the Subnet and add validators.

To get the first `Mainnet` address of your ledger device, first make sure it is connected,
unblocked, and running the Avalanche app. Then execute the `key list` command:

```bash
avalanche key list --ledger 0 --mainnet
```

The command first asks the user to authorize the ledger to give the CLI extended public key
information. Avalanche-CLI needs this information to generate the address list.

An authorization request is a common message in all CLI operations that use Ledger:

```text
*** Please provide extended public key on the ledger device ***
```

On the ledger a `Provide Extended Public Key` window is going to be active. Navigate to the ledger `Accept`
window by using the ledger's right button, and then authorize the request by pressing both left and
right buttons.

```text
+--------+---------+-------------------------+-----------------------------------------------+---------+---------+
|  KIND  |  NAME   |          CHAIN          |                    ADDRESS                    | BALANCE | NETWORK |
+--------+---------+-------------------------+-----------------------------------------------+---------+---------+
| ledger | index 0 | P-Chain (Bech32 format) | P-avax1ucykh6ls8thqpuwhg3vp8vvu6spg5e8tp8a25j |      11 | Mainnet |
+--------+---------+-------------------------+-----------------------------------------------+---------+---------+
```

The command prints the P-Chain address for `Mainnet`,
`P-avax1ucykh6ls8thqpuwhg3vp8vvu6spg5e8tp8a25j`, and its balance. You should fund this address with
at least 2.5 AVAX to cover TX fees. the TX fee for creating your Subnet costs 2 AVAX. Adding
validators costs 0.001 AVAX each. For more details, see [Fees](../quickstart/transaction-fees))

:::note

You can use the `key list` command to get any ledger address in the derivation sequence by
changing the index parameter from `0` to the one desired, or to a list of them (for example: `2`, or
`0,4,7`). Also, you can ask for addresses on `Fuji` with the `--fuji` parameter, and local networks
with the `--local` parameter.

:::

#### Funding the Ledger

A new ledger device has no funds on the addresses it controls. You'll need to send funds to it by
exporting them from the C-Chain to the P-Chain using [Avalanche's Web
Wallet](https://wallet.avax.network).

You can load the Ledger's C-Chain address in the web wallet or load in a different private key. You
can transfer funds from the C-Chain to the P-Chain by clicking on the Cross Chain on the left side
of the web wallet. See this
[tutorial](https://support.avax.network/en/articles/6169872-how-to-make-a-cross-chain-transfer-in-the-avalanche-wallet-between-x-and-c-chain)
for more instructions.

## Deploy the Subnet

With your Ledger unlocked and running the Avalanche app, run

```bash
avalanche subnet deploy testsubnet
```

This is going to start a new prompt series.

```text
Use the arrow keys to navigate: ↓ ↑ → ←
? Choose a network to deploy on:
  ▸ Local Network
    Fuji
    Mainnet
```

This tutorial is about deploying to `Mainnet`, so navigate with the arrow keys to `Mainnet` and hit enter.

The user is then asked to authorize the Ledger to provide extended public key information to the CLI.

```text
✔ Mainnet
Deploying [testsubnet] to Mainnet
*** Please provide extended public key on the ledger device ***
```

This activates a `Provide Extended Public Key` window on the Ledger. Navigate to the Ledger `Accept`
window by using the ledger's right button, and then authorize the request by pressing both left and
right buttons.

After that, CLI shows the `Mainnet` ledger address used to fund the deployment:

```text
Ledger address: P-avax1ucykh6ls8thqpuwhg3vp8vvu6spg5e8tp8a25j
```

The deployment requires running a [createSubnet transaction](../apis/avalanchego/apis/p-chain.md#platformcreatesubnet)
and a [createBlockchain transaction](../apis/avalanchego/apis/p-chain.md#platformcreateblockchain),
and so this first ledger address must have the funds to issue both operations.

This tutorial creates a permissioned Subnet. As such, you must specify which P-Chain addresses can
control the Subnet. These addresses are known as `Control Keys`. The CLI can automatically set your
Ledger's address as the sole control key or the user may specify a custom list.

:::warning

In production Subnets, you should always use multiple control keys running in a multisig
configuration. This tutorial uses a single control key for illustrative purposes only.

For instructions on controlling your Subnet with a multisig, see the [Multisig Deployment
Tutorial](./multisig-deploy).

:::

```text
Configure which addresses may make changes to the subnet.
These addresses are known as your control keys. You are going to also
set how many control keys are required to make a subnet change (the threshold).
Use the arrow keys to navigate: ↓ ↑ → ←
? How would you like to set your control keys?:
  ▸ Use ledger address
    Custom list
```

For this tutorial, opt to use the first ledger address, so enter at `Use ledger address`. Only
this address is going to be able to add or remove validators, or create blockchains on the Subnet.

```text
Your Subnet's control keys: [P-avax1ucykh6ls8thqpuwhg3vp8vvu6spg5e8tp8a25j]
Your subnet auth keys for chain creation: [P-avax1ucykh6ls8thqpuwhg3vp8vvu6spg5e8tp8a25j]
```

Next, the CLI generates a TX for creating the SubnetID and asks the user to sign it by using the Ledger.

```text
*** Please sign subnet creation hash on the ledger device ***
```

This activates a `Sign Hash` window on the Ledger. Navigate to the Ledger's `Accept` window by
using the ledger's right button, and then authorize the request by pressing both left and right buttons.

If the Ledger doesn't have enough funds, the user may see an error message:

```text
*** Please sign subnet creation hash on the ledger device ***
Error: insufficient funds: provided UTXOs need 1000000000 more units of asset "U8iRqJoiJm8xZHAacmvYyZVwqQx6uDNtQeP3CQ6fcgQk3JqnK"
```

If successful, the CLI next asks you to sign a chain creation TX.

```text
Subnet has been created with ID: 2UUCLbdGqawRDND7kHjwq3zXXMPdiycG2bkyuRzYMnuTSDr6db. Now creating blockchain...
*** Please sign blockchain creation hash on the ledger device ***
```

This activates a `Sign Hash` window on the ledger. Navigate to the Ledger's `Accept` window by
using the ledger's right button, and then authorize the request by pressing both left and right buttons.

After that, CLI creates the blockchain within the Subnet, and a summary window for the deployment
appears:

```text
+--------------------+------------------------------------------------------------------------------------+
| DEPLOYMENT RESULTS |                                                                                    |
+--------------------+------------------------------------------------------------------------------------+
| Chain Name         | testsubnet                                                                         |
+--------------------+------------------------------------------------------------------------------------+
| Subnet ID          | 2UUCLbdGqawRDND7kHjwq3zXXMPdiycG2bkyuRzYMnuTSDr6db                                 |
+--------------------+------------------------------------------------------------------------------------+
| VM ID              | rW1esjm6gy4BtGvxKMpHB2M28MJGFNsqHRY9AmnchdcgeB3ii                                  |
+--------------------+------------------------------------------------------------------------------------+
| Blockchain ID      | wNoEemzDEr54Zy3iNn66yjUxXmZS9LKsZYSUciL89274mHsjG                                  |
+--------------------+------------------------------------------------------------------------------------+
| RPC URL            | http://127.0.0.1:9650/ext/bc/wNoEemzDEr54Zy3iNn66yjUxXmZS9LKsZYSUciL89274mHsjG/rpc |
+--------------------+------------------------------------------------------------------------------------+
| P-Chain TXID       | wNoEemzDEr54Zy3iNn66yjUxXmZS9LKsZYSUciL89274mHsjG                                  |
+--------------------+------------------------------------------------------------------------------------+
```

Well done. You have just created your own Subnet running on `Mainnet`. Now it's time to add your validators.

## Add a Validator

:::info

Adding a validator on a Subnet requires that the node is already a validator on the primary network,
which means that your node has **fully bootstrapped**.

See [here](../nodes/validate/add-a-validator.md#add-a-validator-with-avalanche-wallet) on how to become
a validator.

:::

This new Subnet is cool - but it doesn't have any dedicated validators yet. Add one by running the `addValidator`
command and adding the name of the Subnet. To be clear, this does _not start or run_ a validator, it
only whitelists the node as a recognized validator on the Subnet.

```bash
avalanche subnet addValidator testsubnet
```

First choose `Mainnet` as the network to add the Subnet validator into.

```text
Use the arrow keys to navigate: ↓ ↑ → ←
? Choose a network to add validator to.:
  ▸ Fuji
    Mainnet
```

As this operation involves a new [transaction](../apis/avalanchego/apis/p-chain.md#platformaddsubnetvalidator),
CLI needs some address to authorize the Subnet operation.
As there is only one control key in the Subnet, CLI is going to use it for signing.
That address is going to also pay the add Subnet validator TX fee of 0.001 AVAX.

```text
Your subnet auth keys for add validator tx creation: [P-avax1ucykh6ls8thqpuwhg3vp8vvu6spg5e8tp8a25j]
```

Also, as using `Mainnet`, the tool is going to use the first ledger address
as signing address.
So, it's expected that the connected ledger has the Subnet control key as its first address.

Now use the **NodeID** of the validator from the very beginning of this tutorial. For best results make
sure the validator is running and synced.

```text
Next, we need the NodeID of the validator you want to whitelist.

Check https://docs.avax.network/apis/avalanchego/apis/info#infogetnodeid for instructions about how
to query the NodeID from your node
(Edit host IP address and port to match your deployment, if needed).
✔ What is the NodeID of the validator you'd like to whitelist?: NodeID-7Xhw2mDxuDS44j42TCB6U5579esbSt3Lg█
```

-this ID is intentionally modified-

Select 30 as the stake weight. The structure is a bit described at [addSubnetValidator](../apis/avalanchego/apis/p-chain.md#platformaddsubnetvalidator)
under the `weight` section.

```text
Use the arrow keys to navigate: ↓ ↑ → ←
? What stake weight would you like to assign to the validator?:
    Default (20)
  ▸ Custom
```

```text
✔ What stake weight would you like to assign to the validator?: 30
```

Then specify when the validator is going to start validating. The time must be in the future. Custom
option is going to require to enter a specific date in `YYYY-MM-DD HH:MM:SS` format. Follow the default
this time:

```text
Use the arrow keys to navigate: ↓ ↑ → ←
? Start time:
  ▸ Start in one minute
    Custom
```

:::warning

If the `join` command isn't successfully completed before this time elapses and the validator's stake
weight is >20% of the Subnet, the Subnet may have down time.

:::

Finally, specify how long it's going to be validating:

```text
✔ Start in one minute
Use the arrow keys to navigate: ↓ ↑ → ←
? How long should your validator validate for?:
  ▸ Until primary network validator expires
    Custom
```

If choosing `Custom` here, it's needed to enter a **duration**, which is a time span expressed in hours.
For example, say `200 days = 24 \* 200 = 4800h`

```text
✔ How long should this validator be validating? Enter a duration, e.g. 8760h: 4800h
```

CLI shows the user an actual date of when that's now:

```text
? Your validator is going to finish staking by 2023-06-10 13:07:58:
  ▸ Yes
    No
```

Confirm if correct. At this point the prompt series is complete and CLI attempts the transaction:

```text
NodeID: NodeID-7Xhw2mDxuDS44j42TCB6U5579esbSt3Lg
Network: Mainnet
Start time: 2022-11-22 13:07:58
End time: 2023-06-10 13:07:58
Weight: 30
Inputs complete, issuing transaction to add the provided validator information...
```

Next CLI asks the user for ledger authorization:

```text
*** Please provide extended public key on the ledger device ***
```

On the ledger a `Provide Extended Public Key` window is going to be active. Navigate to the ledger `Accept`
window by using the ledger's right button, and then authorize the request by pressing both left and
right buttons.

CLI is going to show the Ledger address:

```text
Ledger address: P-avax1ucykh6ls8thqpuwhg3vp8vvu6spg5e8tp8a25j
```

At this point, if the ledger address isn't the control key for the Subnet, the user is going to get
an error:

```text
Error: wallet doesn't contain subnet auth keys
exit status 1
```

If the ledger hasn't enough funds, the following error message is going to appear:

```text
*** Please sign subnet creation hash on the ledger device ***
Error: insufficient funds: provided UTXOs need 1000000 more units of asset "U8iRqJoiJm8xZHAacmvYyZVwqQx6uDNtQeP3CQ6fcgQk3JqnK"
```

Otherwise, bot the CLI and the ledger are going to request to sign the TX:

```text
*** Please sign add validator hash on the ledger device ***
```

On the ledger a `Sign Hash` window is going to be active. Navigate to the ledger `Accept` window by
using the ledger's right button, and then authorize the request by pressing both left and right buttons.

This might take a couple of seconds, and is going to print, if successful:

```text
Transaction successful, transaction ID: r3tJ4Wr2CWA8AaticmFrKdKgAs5AhW2wwWTaQHRBZKwJhsXzb
```

This means the node is now a validator on the given Subnet on `Mainnet`!

You can get the P-Chain TX id information on [Avalanche Explorer](https://subnets.avax.network/)

## Join a Subnet

You might already have a running validator which you want to add to a specific Subnet. For this, run
the `join` command.
This is a bit of a special command. The `join` command is going to either just _print the required instructions_
for your already running node or is going to attempt at configuring a config file the user provides.

```bash
avalanche subnet join testsubnet
```

First ask for network for which the validator is joining. Choose `Mainnet`:

```text
Use the arrow keys to navigate: ↓ ↑ → ←
? Choose a network to validate on (this command only supports public networks):
  ▸ Fuji
    Mainnet
```

The [deploy the SUBNET](#deploy-the-subnet) section shows that a Subnet is permissioned via a
set of keys. Therefore you can't add any node as validator to the Subnet. A holder of a control key
_must_ call [SUBNET addValidator](../apis/avalanchego/apis/p-chain.md#platformaddsubnetvalidator) first
to allow the node to validate the Subnet. So the tool allows the user now to verify if the node has
already been permissioned -"whitelisted"- to be a validator for this Subnet (by calling an API in the
background).

```text
Would you like to check if your node is allowed to join this subnet?
If not, the subnet's control key holder must call avalanche subnet
addValidator with your NodeID.
Use the arrow keys to navigate: ↓ ↑ → ←
? Check whitelist?:
    Yes
  ▸ No
```

The default is `Yes` but just choose `No` here to speed up things, assuming the node is already whitelisted.

There are now two choices possible: automatic and Manual configuration. As mentioned earlier, "Automatic"
is going to attempt at editing a config file and setting up your plugin directory, while "Manual" is
going to just print the required config to the screen. What "Automatic" does is:

```text
✔ Automatic
✔ Path to your existing config file (or where it's going to be generated): config.json
```

Provide a path to a config file. If this command runs on the box where your validator is running,
then you could point this to the actually used config file, for example
`/etc/avalanchego/config.json` - just make sure the tool has **write** access to the file. Or you could
just copy the file later. In any case, the tool is going to either try to edit the existing file specified
by the given path, or create a new file. Again, set write permissions.

Next, provide the plugin directory. The beginning of this tutorial describes VMs [Virtual Machine](#virtual-machine).
Each VM runs its own plugin, therefore AvalancheGo needs to be able to access the correspondent plugin
binary. As this is the `join` command, which doesn't know yet about the plugin, there is a need to provide
the directory where the plugin resides. Make sure to provide the location for your case:

```text
✔ Path to your avalanchego plugin dir (likely avalanchego/build/plugins): /home/user/go/src/github.com/ava-labs/avalanchego/build/plugins
```

The tool doesn't know where exactly it's located so it requires the full path. With the path given,
it's going to copy the VM binary to the provided location:

```text
✔ Path to your avalanchego plugin dir (likely avalanchego/build/plugins): /home/user/go/src/github.com/ava-labs/avalanchego/build/plugins█
VM binary written to /home/user/go/src/github.com/ava-labs/avalanchego/build/plugins/tGBrMADESojmu5Et9CpbGCrmVf9fiAJtZM5ZJ3YVDj5JTu2qw
This is going to edit your existing config file. This edit is nondestructive,
but it's always good to have a backup.
Use the arrow keys to navigate: ↓ ↑ → ←
? Proceed?:
  ▸ Yes
    No
```

Hitting `Yes` is going to attempt at writing the config file:

```text
✔ Yes
The config file has been edited. To use it, make sure to start the node with the '--config-file'
option, e.g.

./build/avalanchego --config-file config.json

(using your binary location). The node has to be restarted for the changes to take effect.
```

It's **required to restart the node**.

By choosing "Manual" instead, the tool is going to just print _instructions_. The user is going to have
to follow these instructions and apply them to the node. Note that the IDs for the VM and Subnets is
going to be different in your case.

```text
✔ Manual

To setup your node, you must do two things:

1. Add your VM binary to your node's plugin directory
2. Update your node config to start validating the subnet

To add the VM to your plugin directory, copy or scp from /tmp/tGBrMADESojmu5Et9CpbGCrmVf9fiAJtZM5ZJ3YVDj5JTu2qw

If you installed avalanchego manually, your plugin directory is likely
avalanchego/build/plugins.

If you start your node from the command line WITHOUT a config file (e.g. via command
line or systemd script), add the following flag to your node's startup command:

--whitelisted-subnets=2b175hLJhGdj3CzgXENso9CmwMgejaCQXhMFzBsm8hXbH2MF7H
(if the node already has a whitelisted-subnets config, append the new value by
comma-separating it).

For example:
./build/avalanchego --network-id=Mainnet --whitelisted-subnets=2b175hLJhGdj3CzgXENso9CmwMgejaCQXhMFzBsm8hXbH2MF7H

If you start the node via a JSON config file, add this to your config file:
whitelisted-subnets: 2b175hLJhGdj3CzgXENso9CmwMgejaCQXhMFzBsm8hXbH2MF7H

TIP: Try this command with the --avalanchego-config flag pointing to your config file,
this tool is going to try to update the file automatically (make sure it can write to it).

After you update your config, you are going to need to restart your node for the changes to
take effect.
```

## Subnet Export

This tool is most useful on the machine where a validator is or is going to be running. In order to
allow a VM to run on a different machine, you can export the configuration. Just provide a path to
where to export the data:

```bash
avalanche subnet export testsubnet
✔ Enter file path to write export data to: /tmp/testsubnet-export.dat
```

The file is in text format and you shouldn't change it. You can use it to import the configuration
on a different machine.

## Subnet Import

To import a VM specification exported in the previous section, just issue the `import` command with
the path to the file after having copied the file over:

```bash
avalanche subnet import /tmp/testsubnet-export.dat
Subnet imported successfully
```

After this the whole Subnet configuration should be available on the target machine:

```text
avalanche subnet list
+---------------+---------------+----------+-----------+----------+
|    SUBNET     |     CHAIN     | CHAIN ID |   TYPE    | DEPLOYED |
+---------------+---------------+----------+-----------+----------+
| testsubnet    | testsubnet    |     3333 | SubnetEVM | No       |
+---------------+---------------+----------+-----------+----------+
```

## Appendix

### Connect with MetaMask

To connect MetaMask with your blockchain on the new Subnet running on your local computer, you can add
a new network on MetaMask with the following values:

```text
- Network Name: testsubnet
- RPC URL: http://127.0.0.1:9650/ext/bc/2XDnKyAEr1RhhWpTpMXqrjeejN23vETmDykVzkb4PrU1fQjewh/rpc
- ChainID: 3333
- Symbol: TST
```

:::note

Unless you deploy your Subnet on other nodes, you aren't going to be able to use other nodes,
including the public API server `https://api.avax.network/`, to connect to MetaMask.

If you want to open up this node for others to access your Subnet, you should set it up properly with
`https//node-ip-address` instead of `http://127.0.0.1:9650`, however, it's out of scope for this tutorial
on how to do that.

:::
